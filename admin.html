<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Cadastro de Produtos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
  /* Estilo do menu lateral - fundo branco */
  .sidebar {
    width: 220px;
    height: 100vh;
    background: #ffffff;
    color: #000;
    position: fixed;
    top: 0;
    left: 0;
    padding-top: 40px;
  }

  .sidebar a {
    display: block;
    padding: 12px 20px;
    background: #02b7ff;    /* cor suave */
    color: #000;            /* texto preto */
    text-decoration: none;
    font-size: 16px;
    font-weight: 0.9;
    margin: 8px 12px;
    border-radius: 6px;     /* bordas arredondadas */
    border: 1px solid rgb(190, 185, 185);
  }

  .sidebar a:hover {
    background: #096df9;    /* tom um pouco mais escuro */
  }

  .content {
    margin-left: 240px;
    padding: 20px;
  }
</style>

</head>
<body>
     

  <!-- CONTEÚDO PRINCIPAL -->
  <div class="content">
    <div class="container py-4">
      <h2 class="mb-4">Cadastro de Produtos</h2>
<a href="lista_produtos.html" class="btn btn-primary mt-3" style="margin-bottom: 50px;">Lista de Produto</a>
  
      <form id="form-produto" class="card p-4 shadow-sm bg-white">
        <div id="mensagem"></div>

        <div class="mb-3">
          <label for="nome" class="form-label">Nome do Produto</label>
          <input type="text" id="nome" class="form-control" required>
        </div>

        <div class="mb-3">
          <label for="estoque" class="form-label">Estoque</label>
          <input type="number" id="estoque" class="form-control" required min="0">
        </div>

        <div class="mb-3">
          <label for="preco_venda" class="form-label">Preço de Venda</label>
          <input type="number" step="0.01" id="preco_venda" class="form-control" required>
        </div>

        <div class="mb-3">
          <label for="preco_compra" class="form-label">Preço de Compra</label>
          <input type="number" step="0.01" id="preco_compra" class="form-control" required>
        </div>

        <div class="mb-3">
          <label for="imagem_produto" class="form-label">URL da Imagem</label>
          <input type="url" id="imagem_produto" class="form-control" required>
        </div>

        <div class="mb-3">
          <label for="categoria" class="form-label">Categoria</label>
          <select id="categoria" class="form-control" required>
            <option value="">Selecione...</option>
            <option value="Medicamento">Medicamento</option>
            <option value="Produto">Produto</option>
          </select>
        </div>

        <button type="submit" id="btn-cadastrar" class="btn btn-primary w-100">Cadastrar Produto</button>
        <button type="button" id="btn-atualizar" class="btn btn-success w-100 mt-2" style="display:none">Atualizar Produto</button>
      </form>
    </div>
  </div>

  
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://zrstjjhjnaaddlaljnwl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpyc3RqamhqbmFhZGRsYWxqbndsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0ODA1NjEsImV4cCI6MjA3NDA1NjU2MX0.12RypSVOBajdNo5ShrcU1cikIEpJMZdIZIoCjo1HVjc";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById("form-produto");
    const mensagem = document.getElementById("mensagem");
    const submitBtn = document.getElementById("btn-cadastrar");
    const btnAtualizar = document.getElementById("btn-atualizar");

    let editingId = null;

    function getQueryParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    async function loadProductForEdit() {
      const idParam = getQueryParam("id");
      if (!idParam) return;

      editingId = Number(idParam);
      if (Number.isNaN(editingId)) return;

      const { data, error } = await supabase
        .from("produtos")
        .select("*")
        .eq("codigo", editingId)
        .maybeSingle();

      if (error) {
        mensagem.innerHTML = `<div class="alert alert-danger">Erro ao carregar produto: ${error.message}</div>`;
        return;
      }
      if (!data) {
        mensagem.innerHTML = `<div class="alert alert-warning">Produto não encontrado.</div>`;
        return;
      }

      document.getElementById("nome").value = data.nome ?? "";
      document.getElementById("estoque").value = data.estoque ?? 0;
      document.getElementById("preco_venda").value = data.preco_venda ?? "";
      document.getElementById("preco_compra").value = data.preco_compra ?? "";
      document.getElementById("imagem_produto").value = data.imagem_produto ?? "";
      document.getElementById("categoria").value = data.categoria ?? "";

      btnAtualizar.style.display = "block";
      submitBtn.style.display = "none";
    }

    async function atualizarProduto() {
      if (!editingId) return;

      const produto = {
        nome: document.getElementById("nome").value,
        estoque: parseInt(document.getElementById("estoque").value) || 0,
        preco_venda: parseFloat(document.getElementById("preco_venda").value) || 0,
        preco_compra: parseFloat(document.getElementById("preco_compra").value) || 0,
        imagem_produto: document.getElementById("imagem_produto").value,
        categoria: document.getElementById("categoria").value
      };

      const { error } = await supabase
        .from("produtos")
        .update(produto)
        .eq("codigo", editingId);

      if (error) {
        mensagem.innerHTML = `<div class="alert alert-danger">Erro ao atualizar: ${error.message}</div>`;
      } else {
        mensagem.innerHTML = `<div class="alert alert-success">Produto atualizado com sucesso!</div>`;
        setTimeout(() => window.location.href = "lista_produtos.html", 800);
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const produto = {
        nome: document.getElementById("nome").value,
        estoque: parseInt(document.getElementById("estoque").value) || 0,
        preco_venda: parseFloat(document.getElementById("preco_venda").value) || 0,
        preco_compra: parseFloat(document.getElementById("preco_compra").value) || 0,
        imagem_produto: document.getElementById("imagem_produto").value,
        categoria: document.getElementById("categoria").value
      };

      const { data, error } = await supabase
        .from("produtos")
        .insert([produto]);

      if (error) {
        mensagem.innerHTML = `<div class="alert alert-danger">Erro: ${error.message}</div>`;
      } else {
        mensagem.innerHTML = `<div class="alert alert-success">Produto cadastrado com sucesso!</div>`;
        form.reset();
      }
    });

    btnAtualizar.addEventListener("click", () => atualizarProduto());

    loadProductForEdit();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
